<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer</title>
    <meta name="theme-color" content="#007AFF">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="icons/icon-app-192.png" type="image/png">
    
    <!-- Three.js –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- FFLATE –¥–ª—è FBXLoader (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!) -->
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>
    <!-- Three.js –∑–∞–≥—Ä—É–∑—á–∏–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/FBXLoader.js"></script>
    
    <!-- Model Viewer -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="main-screen" class="screen active">
        <div class="container">
            <div class="app-logo">
                <img src="icons/logo-header.png" alt="3D Viewer" class="logo-image">
            </div>
            
            <div id="preview-area" class="preview-area">
                <div id="preview-placeholder" class="preview-placeholder">
                    <span>–í–´–ë–ï–†–ò–¢–ï 3D –ú–û–î–ï–õ–¨</span>
                </div>
                
                <!-- Model Viewer –¥–ª—è GLB/GLTF/OBJ -->
                <model-viewer id="preview-model" class="preview-model" hidden></model-viewer>
                
                <!-- Three.js Canvas –¥–ª—è STL/FBX -->
                <canvas id="preview-threejs" class="preview-threejs" hidden></canvas>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="loading-indicator" class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...</div>
                    <div class="loading-progress">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-text">0%</div>
                    </div>
                </div>
            </div>
            
            <input type="file" id="file-input" accept=".glb,.gltf,.obj,.stl,.fbx" hidden>
            <button id="select-file-btn" class="btn primary">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            <button id="open-3d-btn" class="btn secondary" disabled>–û—Ç–∫—Ä—ã—Ç—å –≤ 3D</button>
            <div id="file-name" class="file-name"></div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
    <div id="viewer-screen" class="screen">
        <header class="header">
            <button id="back-btn" class="back-btn">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="header-logo">
                <img src="icons/logo-header.png" alt="3D Viewer" class="logo-image-small">
            </div>
            <h2 id="viewer-title" class="viewer-title"></h2>
        </header>
        <div class="viewer-container">
            <!-- Model Viewer –¥–ª—è GLB/GLTF/OBJ -->
            <model-viewer id="main-model" class="main-model" 
                camera-controls 
                auto-rotate
                shadow-intensity="1"
                hidden>
            </model-viewer>
            
            <!-- Three.js Canvas –¥–ª—è STL/FBX -->
            <canvas id="main-threejs" class="main-threejs" hidden></canvas>
        </div>
        <div class="viewer-controls">
            <button id="auto-rotate-btn" class="control-btn" data-active="true">
                ‚è∏Ô∏è –ê–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç
            </button>
            <button id="reset-camera-btn" class="control-btn">
                üéØ –°–±—Ä–æ—Å –∫–∞–º–µ—Ä—ã
            </button>
        </div>
    </div>

    <script>
        // üîß –ù–ê–°–¢–û–Ø–©–ò–ô FBX –ó–ê–ì–†–£–ó–ß–ò–ö
        class RealFBXLoader {
            constructor(manager) {
                this.manager = (manager !== undefined) ? manager : THREE.DefaultLoadingManager;
                this.loader = new THREE.FBXLoader(this.manager);
            }

            load(url, onLoad, onProgress, onError) {
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ FBX —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç–æ—è—â–∏–π FBXLoader...');
                
                this.loader.load(url, 
                    (object) => {
                        console.log('‚úÖ FBX –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
                        onLoad(object);
                    }, 
                    onProgress, 
                    onError
                );
            }
        }

        // üîß –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò FBX
        function loadRealFBXModel(url, isPreview = false) {
            return new Promise((resolve, reject) => {
                console.log('üéÆ –ó–∞–≥—Ä—É–∑–∫–∞ FBX —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç–æ—è—â–∏–π –∑–∞–≥—Ä—É–∑—á–∏–∫...');
                
                const loader = new RealFBXLoader();
                
                loader.load(url, 
                    (object) => {
                        console.log('‚úÖ FBX –º–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
                        console.log('üîç –û–±—ä–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:', object.children.length, '–¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤');
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ç–µ–Ω–∏
                        object.traverse((child) => {
                            if (child.isMesh) {
                                console.log('üîç –ù–∞–π–¥–µ–Ω –º–µ—à:', child);
                                child.castShadow = true;
                                child.receiveShadow = true;
                                
                                if (isPreview) {
                                    // –î–ª—è –ø—Ä–µ–≤—å—é - –ø—Ä–æ—Å—Ç—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                                    child.material = new THREE.MeshBasicMaterial({
                                        color: 0x000000,
                                        transparent: true,
                                        opacity: 0.9
                                    });
                                } else {
                                    // –î–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - —É–±–µ–¥–∏–º—Å—è —á—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç
                                    if (!child.material || child.material.isMeshBasicMaterial) {
                                        child.material = new THREE.MeshStandardMaterial({
                                            color: 0x888888,
                                            roughness: 0.7,
                                            metalness: 0.3
                                        });
                                    }
                                }
                            }
                        });
                        
                        resolve(object);
                    },
                    (progress) => {
                        if (progress.lengthComputable) {
                            const percent = Math.round(progress.loaded / progress.total * 100);
                            console.log(`üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏: ${percent}%`);
                        }
                    },
                    (error) => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ FBX:', error);
                        reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å FBX —Ñ–∞–π–ª: ' + error.message));
                    }
                );
            });
        }

        // üîß –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        class ModelViewerApp {
            constructor() {
                this.currentState = 'main';
                this.currentFile = null;
                this.currentFileType = null;
                this.currentRenderer = null;
                this.MAX_FILE_SIZE = 200 * 1024 * 1024;
                
                this.autoRotate = true;
                this.currentFileURL = null;
                
                this.previewScene = null;
                this.previewCamera = null;
                this.previewRenderer = null;
                this.previewModelObject = null;
                
                this.mainScene = null;
                this.mainCamera = null;
                this.mainRenderer = null;
                this.mainModelObject = null;
                this.mainControls = null;
                
                this.lightsInitialized = false;
                
                this.init();
            }

            init() {
                this.initializeElements();
                this.bindEvents();
                this.initThreeJS();
                
                console.log('üöÄ 3D Model Viewer –∑–∞–ø—É—â–µ–Ω');
            }

            initializeElements() {
                this.mainScreen = document.getElementById('main-screen');
                this.viewerScreen = document.getElementById('viewer-screen');
                this.fileInput = document.getElementById('file-input');
                this.selectFileBtn = document.getElementById('select-file-btn');
                this.open3dBtn = document.getElementById('open-3d-btn');
                this.backBtn = document.getElementById('back-btn');
                this.fileName = document.getElementById('file-name');
                this.viewerTitle = document.getElementById('viewer-title');
                this.autoRotateBtn = document.getElementById('auto-rotate-btn');
                this.resetCameraBtn = document.getElementById('reset-camera-btn');
                this.previewPlaceholder = document.getElementById('preview-placeholder');
                this.previewArea = document.getElementById('preview-area');

                this.previewModel = document.getElementById('preview-model');
                this.mainModel = document.getElementById('main-model');
                this.previewThreejs = document.getElementById('preview-threejs');
                this.mainThreejs = document.getElementById('main-threejs');

                this.loadingIndicator = document.getElementById('loading-indicator');
                this.progressFill = document.querySelector('.progress-fill');
                this.progressText = document.querySelector('.progress-text');
            }

            bindEvents() {
                this.selectFileBtn.addEventListener('click', () => {
                    this.fileInput.click();
                });

                this.fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e);
                });

                this.open3dBtn.addEventListener('click', () => {
                    this.openViewer();
                });

                this.backBtn.addEventListener('click', () => {
                    this.showMainScreen();
                });

                this.autoRotateBtn.addEventListener('click', () => {
                    this.toggleAutoRotate();
                });

                this.resetCameraBtn.addEventListener('click', () => {
                    this.resetCamera();
                });

                window.addEventListener('resize', () => {
                    this.handleResize();
                });
            }

            initThreeJS() {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js...');
                
                this.previewScene = new THREE.Scene();
                this.previewCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                this.previewRenderer = new THREE.WebGLRenderer({ 
                    canvas: this.previewThreejs,
                    antialias: true,
                    alpha: true
                });
                this.previewRenderer.setSize(200, 200);
                this.previewRenderer.setClearColor(0x000000, 0);
                
                const previewAmbient = new THREE.AmbientLight(0xffffff, 1.0);
                this.previewScene.add(previewAmbient);
                
                this.mainScene = new THREE.Scene();
                this.mainCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                this.mainRenderer = new THREE.WebGLRenderer({ 
                    canvas: this.mainThreejs,
                    antialias: true,
                    alpha: true
                });
                this.mainRenderer.setClearColor(0x222222, 1);
                
                this.previewCamera.position.set(0, 0, 5);
                this.mainCamera.position.set(0, 0, 5);

                console.log('Three.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                this.animate();
            }

            setupMainLighting() {
                if (this.lightsInitialized) {
                    console.log('üí° –û—Å–≤–µ—â–µ–Ω–∏–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                    return;
                }

                console.log('üí° –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ...');
                
                const ambientLight = new THREE.AmbientLight(0x404080, 0.8);
                this.mainScene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                this.mainScene.add(directionalLight);
                
                this.orbitingLight = new THREE.PointLight(0xffffff, 1.8, 100);
                this.orbitingLight.position.set(8, 4, 0);
                this.orbitingLight.castShadow = true;
                this.mainScene.add(this.orbitingLight);

                const backLight = new THREE.DirectionalLight(0xffffff, 0.6);
                backLight.position.set(-5, 5, -5);
                this.mainScene.add(backLight);
                
                this.lightsInitialized = true;
                console.log('üí° –û—Å–Ω–æ–≤–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑');
            }

            getRendererForFormat(extension) {
                const MODEL_VIEWER_FORMATS = ['.glb', '.gltf', '.obj'];
                const THREE_JS_FORMATS = ['.stl', '.fbx'];
                
                if (MODEL_VIEWER_FORMATS.includes(extension)) {
                    return 'model-viewer';
                } else if (THREE_JS_FORMATS.includes(extension)) {
                    return 'threejs';
                }
                return null;
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.resetPreview();

                if (!this.validateFile(file)) {
                    return;
                }

                this.currentFile = file;
                this.currentFileType = '.' + file.name.split('.').pop().toLowerCase();
                this.currentRenderer = this.getRendererForFormat(this.currentFileType);
                
                if (!this.currentRenderer) {
                    alert('‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    return;
                }

                this.currentFileURL = URL.createObjectURL(file);
                this.showPreview();
            }

            validateFile(file) {
                if (file.size > this.MAX_FILE_SIZE) {
                    alert(`üìÅ –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π\n–†–∞–∑–º–µ—Ä: ${(file.size / (1024 * 1024)).toFixed(1)}MB\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ${(this.MAX_FILE_SIZE / (1024 * 1024)).toFixed(0)}MB`);
                    return false;
                }

                const validFormats = ['.glb', '.gltf', '.obj', '.stl', '.fbx'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validFormats.includes(fileExtension)) {
                    alert(`‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç\n–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: ${validFormats.join(', ')}`);
                    return false;
                }

                return true;
            }

            async showPreview() {
                try {
                    console.log('üîÑ –ü–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é...');
                    this.hidePreviewPlaceholder();
                    this.open3dBtn.disabled = true;
                    this.fileName.textContent = this.currentFile.name;

                    this.hideAllRenderers();
                    
                    if (this.currentRenderer === 'model-viewer') {
                        await this.loadModelViewerPreview();
                    } else if (this.currentRenderer === 'threejs') {
                        await this.loadThreeJSPreview();
                    }

                    this.open3dBtn.disabled = false;
                    this.currentState = 'preview';

                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–≤—å—é:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞:\n' + error.message);
                    this.resetPreview();
                }
            }

            hidePreviewPlaceholder() {
                this.previewPlaceholder.style.display = 'none';
            }

            showPreviewPlaceholder() {
                this.previewPlaceholder.style.display = 'flex';
            }

            async loadModelViewerPreview() {
                return new Promise((resolve) => {
                    console.log('üì± –ó–∞–≥—Ä—É–∑–∫–∞ Model Viewer –ø—Ä–µ–≤—å—é...');
                    
                    this.clearThreeJSScene(this.previewScene);
                    
                    this.previewModel.src = this.currentFileURL;
                    this.previewModel.hidden = false;
                    this.hidePreviewPlaceholder();
                    
                    console.log('‚úÖ Model Viewer –ø—Ä–µ–≤—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
                    
                    setTimeout(() => {
                        console.log('‚úÖ Model Viewer –ø—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                        resolve();
                    }, 1000);
                });
            }

            async loadThreeJSPreview() {
                return new Promise((resolve, reject) => {
                    if (this.currentFileType === '.stl') {
                        const loader = new THREE.STLLoader();
                        console.log('üéÆ –ó–∞–≥—Ä—É–∑–∫–∞ STL –ø—Ä–µ–≤—å—é...');

                        loader.load(this.currentFileURL, (object) => {
                            console.log('‚úÖ STL –ø—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                            
                            this.clearThreeJSScene(this.previewScene);
                            
                            const geometry = object;
                            const material = new THREE.MeshBasicMaterial({ 
                                color: 0x000000,
                                transparent: true,
                                opacity: 0.9
                            });
                            const modelObject = new THREE.Mesh(geometry, material);
                            
                            this.previewScene.add(modelObject);
                            this.previewModelObject = modelObject;
                            
                            this.setupPreviewCamera(modelObject);
                            
                            this.previewThreejs.hidden = false;
                            this.hidePreviewPlaceholder();
                            
                            console.log('‚úÖ STL –ø—Ä–µ–≤—å—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
                            resolve();
                        }, 
                        (progress) => {
                            if (progress.lengthComputable) {
                                this.updateProgress((progress.loaded / progress.total) * 100);
                            }
                        },
                        (error) => {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ STL –ø—Ä–µ–≤—å—é:', error);
                            reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å'));
                        });
                        
                    } else if (this.currentFileType === '.fbx') {
                        console.log('üéØ –ó–∞–≥—Ä—É–∑–∫–∞ FBX –ø—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç–æ—è—â–∏–π FBXLoader...');
                        
                        loadRealFBXModel(this.currentFileURL, true)
                            .then((object) => {
                                console.log('‚úÖ FBX –ø—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å—Ü–µ–Ω—É...');
                                
                                this.clearThreeJSScene(this.previewScene);
                                this.previewScene.add(object);
                                this.previewModelObject = object;
                                
                                console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ü–µ–Ω—ã –ø—Ä–µ–≤—å—é:', this.previewScene.children.length, '–æ–±—ä–µ–∫—Ç–æ–≤');
                                
                                this.setupPreviewCamera(object);
                                this.previewThreejs.hidden = false;
                                this.hidePreviewPlaceholder();
                                
                                console.log('‚úÖ FBX –ø—Ä–µ–≤—å—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
                                resolve();
                            })
                            .catch((error) => {
                                console.error('‚ùå –û—à–∏–±–∫–∞ FBX –ø—Ä–µ–≤—å—é:', error);
                                reject(error);
                            });
                    }
                });
            }

            setupPreviewCamera(object) {
                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                console.log('üìê –†–∞–∑–º–µ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é:', size);
                
                object.position.x = -center.x;
                object.position.y = -center.y;
                object.position.z = -center.z;
                
                this.autoAlignModel(object, size);
                
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = this.previewCamera.fov * (Math.PI / 180);
                let cameraDistance = Math.abs(maxDim / Math.sin(fov / 2)) * 1.2;
                
                cameraDistance = Math.max(cameraDistance, 1);
                
                console.log('üì∑ –î–∏—Å—Ç–∞–Ω—Ü–∏—è –∫–∞–º–µ—Ä—ã –ø—Ä–µ–≤—å—é:', cameraDistance);
                
                this.previewCamera.position.set(cameraDistance * 0.7, cameraDistance * 0.3, cameraDistance * 0.7);
                this.previewCamera.lookAt(0, 0, 0);
                this.previewCamera.updateProjectionMatrix();
            }

            setupMainCamera(object) {
                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                console.log('üìê –†–∞–∑–º–µ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:', size);
                
                object.position.x = -center.x;
                object.position.y = -center.y;
                object.position.z = -center.z;
                
                this.autoAlignModel(object, size);
                
                const maxDim = Math.max(size.x, size.y, size.z);
                let cameraDistance;
                
                if (this.currentFileType === '.stl') {
                    cameraDistance = maxDim * 1.2;
                } else {
                    const fov = this.mainCamera.fov * (Math.PI / 180);
                    cameraDistance = Math.abs(maxDim / Math.sin(fov / 2)) * 2.0;
                }
                
                cameraDistance = Math.max(cameraDistance, 0.5);
                cameraDistance = Math.min(cameraDistance, 15);
                
                console.log('üì∑ –î–∏—Å—Ç–∞–Ω—Ü–∏—è –∫–∞–º–µ—Ä—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:', cameraDistance);
                
                this.mainCamera.position.set(0, 0, cameraDistance);
                this.mainCamera.lookAt(0, 0, 0);
                this.mainCamera.updateProjectionMatrix();
                
                if (this.mainControls) {
                    this.mainControls.minDistance = cameraDistance * 0.3;
                    this.mainControls.maxDistance = cameraDistance * 4;
                    this.mainControls.reset();
                }
            }

            autoAlignModel(object, size) {
                const maxDim = Math.max(size.x, size.y, size.z);
                
                if (size.y === maxDim) {
                    console.log('üéØ –ú–æ–¥–µ–ª—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ');
                    object.rotation.x = 0;
                    object.rotation.y = 0;
                    object.rotation.z = 0;
                } else if (size.z === maxDim) {
                    console.log('üéØ –ú–æ–¥–µ–ª—å –ª–µ–∂–∏—Ç - –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                    object.rotation.x = -Math.PI / 2;
                } else if (size.x === maxDim) {
                    console.log('üéØ –ú–æ–¥–µ–ª—å –Ω–∞ –±–æ–∫—É - –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                    object.rotation.z = -Math.PI / 2;
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                if (this.previewRenderer && this.previewScene && this.previewCamera) {
                    this.previewRenderer.render(this.previewScene, this.previewCamera);
                }
                
                if (this.mainRenderer && this.mainScene && this.mainCamera) {
                    if (this.orbitingLight && this.autoRotate) {
                        const time = Date.now() * 0.001;
                        this.orbitingLight.position.x = Math.cos(time * 0.5) * 8;
                        this.orbitingLight.position.z = Math.sin(time * 0.5) * 8;
                        this.orbitingLight.position.y = 4 + Math.sin(time * 0.3) * 2;
                    }
                    
                    if (this.autoRotate && this.mainModelObject && this.currentRenderer === 'threejs') {
                        this.mainModelObject.rotation.y += 0.01;
                    }
                    
                    this.mainRenderer.render(this.mainScene, this.mainCamera);
                    
                    if (this.mainControls) {
                        this.mainControls.update();
                    }
                }
            }

            clearThreeJSScene(scene) {
                if (scene) {
                    while(scene.children.length > 0) { 
                        scene.remove(scene.children[0]); 
                    }
                }
            }

            hideAllRenderers() {
                console.log('üîÑ –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–Ω–¥–µ—Ä–µ—Ä—ã');
                
                this.previewModel.hidden = true;
                this.previewThreejs.hidden = true;
                this.mainModel.hidden = true;
                this.mainThreejs.hidden = true;
            }

            updateProgress(percent) {
                if (this.progressFill) {
                    this.progressFill.style.width = percent + '%';
                }
                if (this.progressText) {
                    this.progressText.textContent = Math.round(percent) + '%';
                }
            }

            async openViewer() {
                if (!this.currentFile) return;

                console.log('üéØ –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞...');
                this.showLoadingIndicator();

                try {
                    this.viewerTitle.textContent = this.currentFile.name;

                    this.hideAllRenderers();

                    if (this.currentRenderer === 'model-viewer') {
                        await this.openModelViewer();
                    } else if (this.currentRenderer === 'threejs') {
                        await this.openThreeJSViewer();
                    }

                    this.hideLoadingIndicator();
                    this.switchToViewer();

                } catch (error) {
                    this.hideLoadingIndicator();
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–µ–ª–∏:\n' + error.message);
                }
            }

            async openModelViewer() {
                return new Promise((resolve) => {
                    console.log('üì± –û—Ç–∫—Ä—ã—Ç–∏–µ Model Viewer...');
                    
                    this.clearThreeJSScene(this.mainScene);
                    if (this.mainControls) {
                        this.mainControls.dispose();
                        this.mainControls = null;
                    }
                    
                    this.mainModel.src = this.currentFileURL;
                    this.mainModel.autoRotate = true;
                    this.mainModel.hidden = false;
                    
                    console.log('‚úÖ Model Viewer –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    
                    setTimeout(() => {
                        console.log('‚úÖ Model Viewer –∑–∞–≥—Ä—É–∂–µ–Ω');
                        this.updateProgress(100);
                        resolve();
                    }, 500);
                });
            }

            async openThreeJSViewer() {
                return new Promise((resolve, reject) => {
                    if (this.currentFileType === '.stl') {
                        const loader = new THREE.STLLoader();
                        console.log('üéÆ –û—Ç–∫—Ä—ã—Ç–∏–µ STL –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞...');

                        loader.load(this.currentFileURL, (object) => {
                            console.log('‚úÖ STL –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                            
                            this.clearThreeJSScene(this.mainScene);
                            
                            const geometry = object;
                            const material = new THREE.MeshStandardMaterial({ 
                                color: 0xCCCCCC,
                                roughness: 0.3,
                                metalness: 0.1
                            });
                            const modelObject = new THREE.Mesh(geometry, material);
                            
                            this.mainScene.add(modelObject);
                            this.mainModelObject = modelObject;
                            
                            this.setupMainLighting();
                            this.setupMainCamera(modelObject);
                            
                            this.mainControls = new THREE.OrbitControls(this.mainCamera, this.mainThreejs);
                            this.mainControls.enableDamping = true;
                            this.mainControls.dampingFactor = 0.05;
                            
                            this.autoRotate = true;
                            this.mainThreejs.hidden = false;
                            this.updateMainThreeJSSize();
                            
                            console.log('‚úÖ STL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                            this.updateProgress(100);
                            resolve();
                        }, 
                        (progress) => {
                            this.updateProgress((progress.loaded / progress.total) * 100);
                        },
                        (error) => {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                            reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å'));
                        });
                        
                    } else if (this.currentFileType === '.fbx') {
                        console.log('üéØ –ó–∞–≥—Ä—É–∑–∫–∞ FBX –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç–æ—è—â–∏–π FBXLoader...');
                        
                        loadRealFBXModel(this.currentFileURL, false)
                            .then((object) => {
                                console.log('‚úÖ FBX –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫...');
                                
                                this.clearThreeJSScene(this.mainScene);
                                this.mainScene.add(object);
                                this.mainModelObject = object;
                                
                                console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω—ã:', this.mainScene.children.length, '–æ–±—ä–µ–∫—Ç–æ–≤');
                                
                                this.setupMainLighting();
                                this.setupMainCamera(object);
                                
                                this.mainControls = new THREE.OrbitControls(this.mainCamera, this.mainThreejs);
                                this.mainControls.enableDamping = true;
                                this.mainControls.dampingFactor = 0.05;
                                
                                this.autoRotate = true;
                                this.mainThreejs.hidden = false;
                                this.updateMainThreeJSSize();
                                
                                console.log('‚úÖ FBX –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                                this.updateProgress(100);
                                resolve();
                            })
                            .catch((error) => {
                                console.error('‚ùå –û—à–∏–±–∫–∞ FBX –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–µ:', error);
                                reject(error);
                            });
                    }
                });
            }

            updateMainThreeJSSize() {
                if (this.mainRenderer && this.mainThreejs) {
                    const container = this.mainThreejs.parentElement;
                    if (container) {
                        const width = container.clientWidth;
                        const height = container.clientHeight;
                        
                        console.log('üìè –†–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Three.js:', width, 'x', height);
                        
                        this.mainRenderer.setSize(width, height);
                        this.mainCamera.aspect = width / height;
                        this.mainCamera.updateProjectionMatrix();
                        
                        this.mainRenderer.render(this.mainScene, this.mainCamera);
                    }
                }
            }

            handleResize() {
                this.updateMainThreeJSSize();
            }

            switchToViewer() {
                console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                this.mainScreen.classList.remove('active');
                this.viewerScreen.classList.add('active');
                this.currentState = 'viewer';
                
                setTimeout(() => {
                    this.updateMainThreeJSSize();
                }, 100);
                
                this.updateAutoRotateButton();
            }

            toggleAutoRotate() {
                this.autoRotate = !this.autoRotate;
                
                if (this.currentRenderer === 'model-viewer') {
                    this.mainModel.autoRotate = this.autoRotate;
                }
                
                this.updateAutoRotateButton();
            }

            updateAutoRotateButton() {
                const isActive = this.autoRotate;
                this.autoRotateBtn.setAttribute('data-active', isActive.toString());
                this.autoRotateBtn.innerHTML = isActive ? '‚è∏Ô∏è –ê–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç' : '‚ñ∂Ô∏è –ê–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç';
            }

            resetCamera() {
                if (this.currentRenderer === 'model-viewer') {
                    this.mainModel.cameraOrbit = '0deg 75deg 105%';
                } else if (this.currentRenderer === 'threejs' && this.mainModelObject) {
                    this.setupMainCamera(this.mainModelObject);
                    if (this.mainControls) {
                        this.mainControls.reset();
                    }
                    console.log('üéØ –ö–∞–º–µ—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞, –æ—Å–≤–µ—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å');
                }
            }

            showMainScreen() {
                this.viewerScreen.classList.remove('active');
                this.mainScreen.classList.add('active');
                this.currentState = 'main';
                
                this.autoRotate = false;
                if (this.currentRenderer === 'model-viewer') {
                    this.mainModel.autoRotate = false;
                }
                
                this.lightsInitialized = false;
            }

            resetPreview() {
                this.showPreviewPlaceholder();
                this.hideAllRenderers();
                this.open3dBtn.disabled = true;
                this.fileName.textContent = '';
                
                if (this.currentFileURL) {
                    URL.revokeObjectURL(this.currentFileURL);
                    this.currentFileURL = null;
                }
                
                this.currentFile = null;
                this.currentFileType = null;
                this.currentRenderer = null;
                
                this.clearThreeJSScene(this.previewScene);
                this.clearThreeJSScene(this.mainScene);
                
                if (this.mainControls) {
                    this.mainControls.dispose();
                    this.mainControls = null;
                }
                
                this.lightsInitialized = false;
            }

            showLoadingIndicator() {
                this.loadingIndicator.classList.add('active');
            }

            hideLoadingIndicator() {
                this.loadingIndicator.classList.remove('active');
                this.updateProgress(0);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            new ModelViewerApp();
        });
    </script>
</body>
</html>
